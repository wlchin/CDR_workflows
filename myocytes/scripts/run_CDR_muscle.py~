
import anndata as ad
from pycdr.pycdr import run_CDR_analysis
from pycdr.perm import calculate_enrichment
from enrich_cdr.encdr import do_enrichment_all

INPUT = snakemake.input[0]
OUTPUT = snakemake.output[0]

mono = ad.read(INPUT)

run_CDR_analysis(mono, "Hours")
mono.write("mustemp.h5ad")

do_enrichment_all(mono, "../data/PANTHERGOslim.obo", "../data/gene2go", "human", threshold_pvalue = 0.05, ontology_subset = "BP", prop = False)
factor_list = [i for i in mono.uns["factor_loadings"].keys()]
calculate_enrichment(mono, "Hours", factor_list, 100, "gene_short_name", 0.05)

mono.write(OUTPUT)
